<html>
    <head>
        <meta charset = 'UTF-8' />
        <title>PrefabDocument</title>
        <link rel="stylesheet" type="text/css" href="./css/prefab_documenter.css">
        <script crossorigin src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
        <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
        <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/0.5.0/js/sql.js"></script>
        <script type="text/babel">
            let db = new SQL.Database();

            class Builder extends React.Component {
                
                constructor(props) {
                    super(props);
                    this.state = {
                        value : null
                    };
                }

                render() {
                    var prefabsRowList = [];

                    if(this.state.value != null) {
                        let stmt = (this.state.value).prepare("select * from Document;");
                        stmt.getAsObject({$guid:1 , $filename:2, $filepath:3, $indentLevel:4, $description:5});

                        stmt.bind({$guid:1 , $filename:2, $filepath:3, $indentLevel:4, $description:5});
                        while(stmt.step()) {
                            var row = stmt.getAsObject();

                            prefabsRowList.push(row);
                        }
                    }

                    return (
                        <div>
                            <label>
                                <input type="file" id="dbFile" onChange={this.onchange.bind(this)}></input>
                            </label>

                            <div id="prefab">
                                {prefabsRowList.map((data) => {
                                    return (
                                        <FileInfoComponent FileData={data} />
                                    );
                                })}
                            </div>
                        </div>
                    );
                }

                onchange(e) {
                    new Promise((resolver, reject) => {
                        let dbFileElm = document.getElementById('dbFile');
                        let f = dbFileElm.files[0];
                        let r = new FileReader();

                        r.onload = function() {
                            let Units = new Uint8Array(r.result);
                            let db = new SQL.Database(Units);

                            resolver(db);
                        }

                        r.readAsArrayBuffer(f);

                    }).then((result) => {
                        this.setState({ value: result });
                    });

                }
            }

            class FileInfoComponent extends React.Component {
                constructor(props) {
                    super(props);
                    this.state = {
                        checked : true
                    };
                }

                render() {
                    return (
                        <div>
                            <input type="checkbox" checked={this.state.checked} onClick={this.onClick.bind(this)} />
                            <h2 id="fileName">{this.props.FileData.filename}</h2>
                            {(() => {
                                if(this.state.checked) {
                                    return (
                                        <div>
                                            <h3>FilePath</h3>
                                            <p id="filePath">{this.props.FileData.filepath}</p>
                                            <h3>Guid</h3>
                                            <p id="guid">{this.props.FileData.guid}</p>
                                            <h3>Description</h3>
                                            <p id="description">{this.props.FileData.description}</p>
                                        </div>
                                    );
                                }
                                else {
                                    return null;
                                }
                            })()}
                        </div>
                    );
                }

                onClick(e) {
                    this.setState({checked : !this.state.checked});
                }
            }

            ReactDOM.render(
                <Builder />
                , document.getElementById('Documents')
            );
        </script>
    </head>

    <body>
        <h1>Prefabs</h1>
        
        <div id="Documents">
        </div>
    </body>
</html>